# ğŸ§  High-Level Architecture (v1)

> Legacy reference only. Superseded by `02-system-architecture.md`, `03-canonical-contracts.md`, and `05-mvp-scope.md`.

## Core Principle

- Game engine = deterministic
- LLM = narrative + world intelligence
- Database = source of truth
- Vector store = world knowledge
- Event system = multiplayer + SFX triggers

---

## ğŸ— System Architecture

### 1ï¸âƒ£ Frontend (Web App)

**Tech stack suggestion**

- Next.js (React)
- Tailwind / shadcn
- WebSocket client
- Web Audio API for SFX
- Optional WebRTC for voice later

```
--------------------------------------------------
| Map / Scene | Story Feed / DM Narrative       |
|             |---------------------------------|
|             | Player Input Box                |
--------------------------------------------------
| Character Sheets | Inventory | Quests | Log   |
--------------------------------------------------
```

### 2ï¸âƒ£ Backend (Authoritative Game Server)

**You DO NOT want LLM controlling state directly.**

**Recommended:**

- Node.js (Fastify/Nest)
- PostgreSQL
- Redis (real-time events + session cache)
- WebSockets (multiplayer sync)

---

## ğŸ—ƒ Database Schema (Simplified v1)

| Table                           | Key fields                                                                                                                 |
| ------------------------------- | -------------------------------------------------------------------------------------------------------------------------- |
| **Users**                       | id, email, password_hash, created_at                                                                                       |
| **Campaigns**                   | id, title, edition (5e, 3.5, etc.), world_type (custom \| forgotten_realms \| homebrew), owner_id, created_at              |
| **Players**                     | id, campaign_id, user_id, character_id, role (player \| gm)                                                                |
| **Characters**                  | id, campaign_id, name, race, class, level, stats_json, inventory_json, spellbook_json, hp_current, hp_max, conditions_json |
| **NPCs**                        | id, campaign_id, name, description, relationship_json, stats_json, voice_profile                                           |
| **Locations**                   | id, campaign_id, name, description, map_seed, metadata_json                                                                |
| **Events** (Event Sourcing Log) | id, campaign_id, type (attack, dialogue, quest_update, travel, etc.), payload_json, created_at                             |
| **Session_Summaries**           | campaign_id, summary_text, updated_at                                                                                      |

---

## ğŸ§© Vector Store (World Knowledge)

**Use:**

- PGVector (inside Postgres)
- Or external (Pinecone, Weaviate)

**Collections**

1. **Rules Knowledge** â€” Chunked SRD / edition rules, tagged by edition
2. **World Knowledge** â€” PDF chunks, lore, geography, factions, gods, history
3. **Monster & Spell Reference** â€” Structured stat blocks

**Each chunk metadata:**

```json
{
  "edition": "5e",
  "source": "PHB",
  "chapter": "Combat",
  "type": "rule",
  "page": 134
}
```

---

## ğŸ§  LLM Role (DM Brain)

The LLM never edits DB directly.

**It gets:**

- Current scene summary
- Active players
- Location info
- Relevant lore chunks (RAG)
- Recent event history
- Allowed tools

**It returns:**

- Narrative
- Optional tool calls

---

## ğŸ›  Tool Definitions (Critical)

These are backend functions the LLM can call.

**roll_dice**

```json
{
  "dice": "1d20",
  "modifier": 5,
  "reason": "Perception check"
}
```

**apply_damage**

```json
{
  "target_id": "npc_123",
  "amount": 12,
  "type": "fire"
}
```

**create_npc**

```json
{
  "name": "...",
  "role": "merchant",
  "disposition": "friendly"
}
```

**update_quest**

```json
{
  "quest_id": "...",
  "status": "completed"
}
```

**change_location**

```json
{
  "location_id": "forest_ruins"
}
```

**trigger_sound**

```json
{
  "sound": "sword_hit",
  "intensity": "medium"
}
```

Backend validates every call.

---

## ğŸ­ Prompt Structure (Simplified)

**System Prompt**

> "You are a Dungeon Master following strict D&D 5e rules. You must use tools for dice rolls and state changes. Never fabricate rolls."

**Runtime Injection**

- Current location summary: â€¦
- Active characters: â€¦
- Recent events: â€¦
- Relevant rules: â€¦
- Relevant lore: â€¦

---

## ğŸ” Game Loop Flow

1. Player types action.
2. Backend: validates state, retrieves relevant lore + rules
3. LLM generates: narrative, tool calls
4. Backend executes tools.
5. State updated.
6. Response streamed to clients.
7. Event logged.

---

## ğŸ¨ Image Generation (v1)

**When:**

- New NPC created
- New location discovered

**Backend:**

- Generates prompt from structured data
- Calls image model
- Saves URL to DB
- Returns to frontend

Keep a consistent art style seed.

---

## ğŸ”Š Voice System (v2 Phase)

**Pipeline:**

1. LLM produces narrative
2. Convert to speech via TTS
3. Stream audio
4. Trigger ambient SFX based on event type

**Later:** Assign voice profile per NPC

---

## ğŸš€ MVP vs V2

### ğŸŸ¢ MVP (3â€“4 months realistic build)

- Text-only DM
- Character creation (basic)
- Single edition (5e)
- SRD rules only
- PDF lore ingestion (manual)
- Save/load campaigns
- Single campaign multiplayer
- Dice engine
- Basic NPC generator
- Scene image generation
- Session summaries

### ğŸŸ¡ V2

- Multiple editions
- Voice narration
- NPC voice personalities
- Dynamic music engine
- Procedural map generator
- Relationship graph memory
- Faction simulation
- Persistent world economy
- AI-driven political systems
- AI personality tuning per campaign
- Mobile client

---

## âš ï¸ Biggest Engineering Challenges

1. Maintaining strict rule correctness
2. Preventing LLM narrative contradictions
3. Context compression strategy
4. Real-time multiplayer sync
5. Cost control for LLM calls
6. Licensing issues for official books

---

## ğŸ’° Is this feasible?

| Aspect                     | Answer                           |
| -------------------------- | -------------------------------- |
| **Technically**            | yes                              |
| **Commercially**           | depends on licensing + UX polish |
| **Engineering difficulty** | high but achievable              |

This is essentially: **AI Dungeon Master + Virtual Tabletop + Lore Engine + Procedural World Builder**
